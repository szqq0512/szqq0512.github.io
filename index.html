<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="QQXZ.COM,青青小竹,旅游,旅行,景点,国保,风景,城市介绍,乡村介绍,中文旅行网站,旅行参考,旅游指南">
    <meta name="description" content="QQXZ.COM,青青小竹,青青小竹网,个人旅游资料收集,旅游资源">
    <title>青青小竹网 | 旅游百科 | 各地景点</title>
    <script src="https://demo.likeyunba.com/md-marked/marked.min.js"></script>
    <style>
        /* 主样式 */
        :root {
            --primary: #6c5ce7;
            --secondary: #fd79a8;
            --accent: #00cec9;
            --light: #f7f7ff;
            --dark: #2d3436;
            --sidebar-bg: #fff;
            --content-bg: #f9f9f9;
            --card-bg: #fff;
            --border: #e0e0e0;
            --text: #3d3d3d;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--content-bg);
            color: var(--text);
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            -moz-user-select: none;
        }
        header {
            background: linear-gradient(135deg, var(--primary) 0%, #5d4ae0 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            z-index: 100;
        }
        hr { margin: -0.5rem 0; }
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 90%;
            max-width: 3840px;
            margin: 0 auto;
            flex-wrap: wrap;
            gap: 12px;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .logo a { color: white; text-decoration: none; }
        nav ul {
            display: flex;
            list-style: none;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
            padding-left: 20px;
        }
        nav li { margin: 3px 0; }
        nav a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 30px;
            font-weight: 500;
            background-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            font-size: 0.95rem;
            display: block;
        }
        nav a:hover, nav a.active {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .mobile-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
        }
        .sidebar-header .toggle-btn { display: none; }
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            width: 90%;
            max-width: 3840px;
            margin: 10px auto;
            padding: 0 10px;
            gap: 15px;
        }
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            font-size: 0.98rem;
            padding: 10px 12px 10px 12px;
            background: linear-gradient(135deg, var(--primary) 0%, #5d4ae0 100%);
            border-radius: 16px 16px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .sidebar-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0 0 10px 0;
            white-space: nowrap;
            overflow: hidden;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .search-bar {
            display: flex;
            align-items: center;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            padding: 2px 8px;
            gap: 6px;
            min-width: 0;
            height: 36px;
            min-height: 36px;
            max-height: 38px;
        }
        .search-bar input {
            border: none;
            outline: none;
            background: transparent;
            flex: 1;
            font-size: 1em;
            padding: 4px 0;
            min-width: 0;
            height: 28px;
            line-height: 28px;
        }
        .search-type {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0 10px;
            border-radius: 12px;
            background: #f5f5fa;
            font-size: 1em;
            color: #6c5ce7;
            user-select: none;
            position: relative;
            height: 28px;
            min-width: 70px;
            line-height: 28px;
        }
        .search-type .dropdown-arrow { margin-left: 2px; font-size: 0.9em; }
        .search-type-dropdown {
            position: absolute;
            top: 110%;
            left: 0;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            min-width: 90px;
            z-index: 10;
            font-size: 1em;
            overflow: hidden;
        }
        .search-type-dropdown div {
            padding: 8px 16px;
            cursor: pointer;
            color: #6c5ce7;
            background: #fff;
            transition: background 0.15s;
        }
        .search-type-dropdown div:hover { background: #e0ebff; }
        #search-clear {
            transition: color 0.15s;
        }
        #search-clear:hover {
            color: #fdcb6e;
            background: #f5f6fa;
            border-radius: 50%;
        }
        @media (max-width: 600px) {
            .search-bar { padding: 0 2px; }
            .search-type { min-width: 54px; font-size: 0.98em; }
            .search-bar input { font-size: 0.98em; }
            .search-no-result { font-size: 0.98em; margin: 2px 2px 6px 2px; padding: 6px 8px; }
        }
        .tree-view {
            padding: 10px 0;
            flex: 1;
            overflow-y: auto;
            background: var(--sidebar-bg);
        }
        .folder, .file, .heading-item {
            padding: 6px 10px 6px 1em;
            margin: 2px 5px;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            min-height: 28px;
            white-space: nowrap;
            overflow: hidden;
            background: var(--light);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
        }
        .heading-item { padding-left: 2em; }
        .folder:hover, .file:hover, .heading-item:hover { background: #e0ebff; }
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--content-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }
        .markdown-container {
            flex: 1;
            overflow-y: auto;
            padding: 2em;
            background: var(--card-bg);
            padding-bottom: max(2em, 12vh, env(safe-area-inset-bottom, 32px));
        }
        .markdown-content {
            line-height: 1.7;
            color: var(--text);
            font-size: 1.05rem;
            text-align: left;
        }
        .markdown-content > p { margin-top: 1em; }
        .markdown-content a { text-decoration: none; color: var(--primary); }
        .markdown-content a:hover { color: var(--accent); }

        /* 标题样式修复 - 确保生效 */
        .markdown-content h1 {
            color: #6c5ce7 !important;
            font-size: 2rem !important;
            padding-bottom: 4px !important;
            border-bottom: 1px solid #e0e0e0 !important;
        }

        .markdown-content h2 {
            color: #00cec9 !important;
            font-size: 1.7rem !important;
            margin: 25px 0 15px !important;
            padding-bottom: 4px !important;
            border-bottom: 1px solid #e0e0e0 !important;
        }

        .markdown-content h3 {
            color: #fd79a8 !important;
            font-size: 1.4rem !important;
            margin: 25px 0 15px !important;
            padding-bottom: 4px !important;
            border-bottom: 1px solid #e0e0e0 !important;
        }

        .markdown-content ul { list-style: none; }
        .markdown-content ul > li {
            position: relative;
            padding: 0.25em 0.5em;
            text-indent: -0.5em;
        }
        .markdown-content ul > li:nth-child(odd) { background-color: #f0f5ff; }
        .markdown-content blockquote {
            text-indent: 0em;
            font-size: 0.92em;
            font-style: italic;
            color: #008080;
            margin-left: 1em;
            border-left: 0.12em solid #008080;
            padding: 0 0.6em;
            border-radius: 0 8px 8px 0;
        }
        .markdown-content em { color: #346c91; font-style: normal; }
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #b0b0b0;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .welcome-image {
            max-width: 80%;
            border-radius: 10px;
            margin-top: 20px;
            opacity: 1;
            height: auto; /* 确保高度自适应 */
        }
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin: 0 auto;
            text-align: center;
        }
        .children { display: none; }
        .folder.expanded + .children { display: block; }
        .tree-view .children {margin-left: 10px; }
        .tree-view .children .folder,
        .tree-view .children .file { margin-left: 10px; }
        .markdown-content img {
            display: block;
            margin: 1em auto;
            width: auto;
            max-width: min(100%, 1500px);
            height: auto;
        }
        @media (max-width: 992px) {
            .top-nav { width: 100%; }
            .container { width: 100%; flex-direction: column; padding: 0; margin: 0; gap: 0; }
            .sidebar { width: 100%; border-radius: 0; max-height: 40vh; box-shadow: none; border-bottom: 1px solid var(--border); }
            .sidebar.collapsed .tree-view { display: none; } 
            .sidebar.collapsed { overflow: hidden; }
            .sidebar-header .toggle-btn { display: block; }
            .content { border-radius: 0; box-shadow: none; }
            .markdown-container { padding: 0.8em; padding-bottom: 18vh !important; }
            nav li { flex: 1 0 45%; text-align: center; }
            .mobile-toggle { display: block; }
            nav { display: none; width: 100%; }
            nav.active { display: block; }
            .top-nav { flex-direction: column; }
            .logo-container { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        }
        .toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px 10px;
        }
        .toggle-btn .emoji-icon { font-size: 1.6em; color: #fff; }
        .search-hit {
            background: #ffe066 !important;
            color: #d35400 !important;
            border-radius: 4px;
            padding: 0 2px;
        }
        .tree-view .search-hit {
            font-weight: bold;
            border: 1.5px solid #fdcb6e;
        }
        .search-no-result {
            display: none;
            text-align: left;
            color: #b36b00;
            background: #fffbe6;
            border-radius: 10px;
            margin: 2px 10px 6px 10px;
            padding: 7px 14px 7px 14px;
            font-size: 1em;
            box-shadow: 0 1px 3px rgba(255,193,7,0.08);
            border: 1px solid #ffe066;
            min-height: 1.5em;
            line-height: 1.5em;
            font-weight: 500;
        }
        
        /* 新增样式 */
        .error-message {
            display: none;
            background: #ffebee;
            color: #b71c1c;
            padding: 15px;
            border-radius: 8px;
            margin: 15px;
            text-align: center;
            font-weight: 500;
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #333;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        @media (max-width: 600px) {
            .markdown-content {
                font-size: 1rem;
            }
            .folder, .file {
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="top-nav">
            <div class="logo-container">
                <div class="logo">
                    <span class="emoji-icon" aria-hidden="true">📖</span>
                    <a href="index.html"><span>青青小竹网</span></a>
                </div>
                <button id="mobile-menu-toggle" class="mobile-toggle" aria-label="展开菜单">
                    <span class="emoji-icon" aria-hidden="true">☰</span>
                    <span class="sr-only">菜单</span>
                </button>
            </div>
            <nav id="top-nav">
                <ul id="nav-menu">
                    <!-- 导航菜单将通过JS动态生成 -->
                </ul>
            </nav>
        </div>
    </header>
    
    <div class="error-message" id="error-message"></div>
    
    <div class="toast" id="toast"></div>
    
    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="search-bar" id="search-bar" style="flex:1;position:relative;margin:6px;">
                <div class="search-type" id="search-type" tabindex="0">
                    <span id="search-type-label">菜单</span>
                    <span class="dropdown-arrow">▼</span>
                    <div class="search-type-dropdown" id="search-type-dropdown" style="display:none;">
                        <div data-type="menu">菜单</div>
                        <div data-type="content">内容</div>
                    </div>
                </div>
                <input id="search-input" type="text" placeholder="搜索菜单文档..." style="padding-right:0.5em;" />
                <span id="search-clear" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:1.3em;cursor:pointer;color:#6c5ce7;user-select:none;z-index:2;width:1.5em;height:1.5em;line-height:1.5em;text-align:center;">╳</span>
            </div>
            <div id="search-no-result" class="search-no-result" style="display:none;">无此搜索项</div>
            <div class="sidebar-header" id="sidebar-header">
                <h2 style="margin-bottom:8px;margin-top:8px;">
                    <span class="emoji-icon" aria-hidden="true">📁</span>
                    <span id="sidebar-title"></span>
                </h2>
                <button class="toggle-btn" id="toggle-sidebar" data-collapsed="false" style="margin-left:8px;">
                    <span class="emoji-icon" aria-hidden="true">▽</span>
                    <span class="sr-only">折叠/展开</span>
                </button>
            </div>
            <div class="tree-view" id="tree-view"></div>
        </aside>
        
        <main class="content" id="content">
            <div class="empty-state">
                <h2>欢迎使用青青小竹网</h2>
                <br>
                <p>一个简单的使用Markdown语法的个人笔记。</p>  
                <br>
                <p>从网上搜集整理的旅游相关资料，主要罗列了中国各地的概况、景点及特色村寨等，方便查找和出行规划。</p>
                <br>
                <p>请选择要查看的文件</p>
                <br>
                <img src="https://s1.imagehub.cc/images/2025/06/13/bf3432b185d01be77f7f9f78f3a79dd7.webp" 
                     alt="欢迎使用青青小竹网"
                     class="welcome-image" 
                     loading="lazy">
            </div>
        </main>
    </div>

    <script>
        (function () {
            // 变量声明
            const $ = {
                navMenu: document.getElementById('nav-menu'),
                treeView: document.getElementById('tree-view'),
                sidebar: document.getElementById('sidebar'),
                sidebarHeader: document.getElementById('sidebar-header'),
                content: document.getElementById('content'),
                toggleSidebar: document.getElementById('toggle-sidebar'),
                mobileMenuToggle: document.getElementById('mobile-menu-toggle'),
                topNav: document.getElementById('top-nav'),
                errorMessage: document.getElementById('error-message'),
                toast: document.getElementById('toast')
            };
            const searchInput = document.getElementById('search-input');
            const cache = {
                dirCache: {},
                mdContent: {},
                headings: {},
                markedLoaded: false,
                currentFile: null,
                initialContentHTML: '',
                currentFolderPath: '',
                lastSearchKeyword: '',
                hasSearchResult: false,
                treeState: {} // 保存树形菜单的展开状态
            };
            let fullTree = null;
            const cleanPath = p => p ? p.replace(/\\/g, '/').trim() : '';
            
            // 显示错误信息
            function showError(message) {
                if ($.errorMessage) {
                    $.errorMessage.textContent = message;
                    $.errorMessage.style.display = 'block';
                }
                showToast(message, 'error');
            }
            
            // 显示成功消息
            function showToast(message, type = 'info') {
                const toast = $.toast;
                if (!toast) return;
                
                toast.textContent = message;
                toast.className = 'toast';
                
                if (type === 'error') {
                    toast.style.backgroundColor = '#f44336';
                } else if (type === 'success') {
                    toast.style.backgroundColor = '#4caf50';
                } else {
                    toast.style.backgroundColor = '#333';
                }
                
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
            
            // 隐藏错误信息
            function hideError() {
                if ($.errorMessage) {
                    $.errorMessage.style.display = 'none';
                }
            }
            
            // 正则表达式转义函数
            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
            
            // 侧边栏操作统一函数
            function toggleSidebar() {
                if(window.innerWidth <= 992) {
                    $.sidebar.classList.toggle('collapsed');
                    const icon = $.toggleSidebar.querySelector('.emoji-icon');
                    const collapsed = $.sidebar.classList.contains('collapsed');
                    $.toggleSidebar.setAttribute('data-collapsed', collapsed);
                    icon.textContent = collapsed ? '△' : '▽';
                } else {
                    // 桌面端保持展开状态
                    $.sidebar.classList.remove('collapsed');
                    const icon = $.toggleSidebar.querySelector('.emoji-icon');
                    $.toggleSidebar.setAttribute('data-collapsed', false);
                    if (icon) icon.textContent = '▽';
                }
            }
            
            // 展开侧边栏（在需要时）
            function expandSidebarIfNeeded() {
                if(window.innerWidth <= 992 && $.sidebar.classList.contains('collapsed')) {
                    $.sidebar.classList.remove('collapsed');
                    const icon = $.toggleSidebar.querySelector('.emoji-icon');
                    $.toggleSidebar.setAttribute('data-collapsed', false);
                    if (icon) icon.textContent = '▽';
                }
            }

            // 目录数据加载
            async function loadVxJson(path) {
                path = cleanPath(path||'');
                if (cache.dirCache[path]) return cache.dirCache[path];
                
                // 修复路径拼接问题
                let url;
                if (!path) {
                    url = '旅游/vx.json';
                } else {
                    // 确保路径结尾没有斜杠
                    const cleanPath = path.replace(/\/$/, ''); 
                    url = `旅游/${cleanPath}/vx.json`;
                }
                
                try {
                    let r = await fetch(url);
                    if (!r.ok) {
                        showError(`无法加载目录数据: ${r.status} ${r.statusText}`);
                        return {folders:[],files:[]};
                    }
                    let d = await r.json();
                    cache.dirCache[path] = d; 
                    hideError();
                    return d;
                } catch (error) {
                    showError(`加载目录失败: ${error.message}`);
                    return {folders:[],files:[]};
                }
            }
            
            // 设置侧栏标题
            function setSidebarTitle(path) {
                const sidebarTitle = document.getElementById('sidebar-title');
                if (!sidebarTitle) return;
                
                if (!path || path === '') {
                    sidebarTitle.textContent = '青青小竹网';
                } else {
                    const arr = path.split('/');
                    sidebarTitle.textContent = arr[arr.length-1] || '青青小竹网';
                }
            }
            
            async function loadFolder(path) {
                // 保存当前路径
                cache.currentFolderPath = path;
                
                $.treeView.innerHTML = '<div class="loader"></div>';
                try {
                    let d = await loadVxJson(path);
                    $.treeView.innerHTML = '';
                    d.folders.forEach(f=>$.treeView.appendChild(folderElem(f, path)));
                    d.files.forEach(f=>$.treeView.appendChild(fileElem(f, path)));
                    updateNav(path); 
                    setSidebarTitle(path);
                } catch (error) {
                    showError(`加载文件夹失败: ${error.message}`);
                }
            }
            
            function folderElem(f, p) {
                let c = document.createElement('div'), e = document.createElement('div');
                e.className = 'folder'; 
                e.innerHTML = '<span class="emoji-icon" aria-hidden="true">📁</span>' + f.name;
                e.dataset.path = p?p+'/'+f.name:f.name; 
                e.title = f.name;
                let ch = document.createElement('div'); 
                ch.className = 'children';
                c.appendChild(e); 
                c.appendChild(ch); 
                return c;
            }
            
            function fileElem(f, p) {
                let c = document.createElement('div'), e = document.createElement('div');
                e.className = 'file';
                let n = f.name.endsWith('.md')?f.name.slice(0,-3):f.name;
                e.innerHTML = '<span class="emoji-icon" aria-hidden="true">📄</span>' + n;
                e.dataset.path = p?p+'/'+f.name:f.name; 
                e.title = n;
                let ch = document.createElement('div'); 
                ch.className = 'children'; 
                ch.style.display='none';
                c.appendChild(e); 
                c.appendChild(ch); 
                return c;
            }
            
            function updateNav(path) {
                let n = path.split('/')[0];
                document.querySelectorAll('#nav-menu a').forEach(a=>a.classList.toggle('active',a.dataset.path===n));
            }
            
            async function fetchMd(filePath) {
                let full = `旅游/${filePath}`;
                if (cache.mdContent[full]) return cache.mdContent[full];
                try {
                    let r = await fetch(full); 
                    if (!r.ok) {
                        showError(`无法加载文档: ${r.status} ${r.statusText}`);
                        return '';
                    }
                    let t = await r.text(); 
                    cache.mdContent[full]=t; 
                    hideError();
                    return t;
                } catch (error) {
                    showError(`加载文档失败: ${error.message}`);
                    return '';
                }
            }
            
            function parseHeadings(md) {
                if (cache.headings[md]) return cache.headings[md];
                let h=[], t=window.marked.lexer(md);
                t.forEach(tok=>{if(tok.type==='heading'&&tok.depth<=3)h.push({level:tok.depth,text:tok.text})});
                cache.headings[md]=h; 
                return h;
            }
            
            async function showMd(filePath, headingsContainer) {
                await checkMarkedLoaded();
                let md = await fetchMd(filePath), h = parseHeadings(md);
                let cont = document.createElement('div'); 
                cont.className='markdown-container';
                let area = document.createElement('div'); 
                area.className='markdown-content';
                let renderer = new window.marked.Renderer(), hid=0;
                
                // Marked.js v13+专用标题渲染器
                renderer.heading = function(token) {
                    const level = token.depth;
                    return `<h${level} id="heading-${level}-${hid++}">${token.text}</h${level}>`;
                };
                
                // 添加安全配置
                area.innerHTML = window.marked.parse(md, {
                    renderer,
                    sanitize: true,
                    breaks: false,
                    gfm: true
                });
                cont.appendChild(area);
                genHeadingsTree(h, headingsContainer);
                $.content.innerHTML = ''; 
                $.content.appendChild(cont);
                return cont;
            }
            
            function genHeadingsTree(h, c) {
                c.innerHTML=''; 
                c.style.display='block';
                h.forEach(he=>{
                    let hi=document.createElement('div'); 
                    hi.className=`heading-item h${he.level}`;
                    let icon=he.level===1?'›&nbsp; ':he.level===2?'&nbsp;»&nbsp; ':he.level===3?'&nbsp;&nbsp;»›&nbsp; ':'';
                    hi.innerHTML=`<span class="emoji-icon" aria-hidden="true">${icon}</span><span>${he.text}</span>`;
                    hi.onclick=e=>{
                        e.stopPropagation();
                        scrollToHeading(he.text,he.level);
                    };
                    c.appendChild(hi);
                });
            }
            
            function scrollToHeading(text, level) {
                let hs=document.querySelectorAll(`h${level}`);
                let t=Array.from(hs).find(h=>h.textContent===text);
                if(t){
                    let c=document.querySelector('.markdown-container');
                    let cr=c.getBoundingClientRect();
                    let tr=t.getBoundingClientRect();
                    let st=c.scrollTop;
                    let off=tr.top-cr.top+st-12;
                    c.scrollTo({top:off,behavior:'smooth'});
                }
            }
            
            async function checkMarkedLoaded() {
                if (window.marked) return;
                await new Promise(r=>{
                    let i=setInterval(()=>{
                        if(window.marked){
                            clearInterval(i);
                            r();
                        }
                    },100);
                });
            }
            
            // 构建全量树
            async function buildFullTree() {
                async function walk(path) {
                    const data = await loadVxJson(path);
                    let node = {
                        name: path.split('/').pop()||'根目录', 
                        path, 
                        type:'folder', 
                        children:[]
                    };
                    
                    (data.folders||[]).forEach(f=>{
                        node.children.push(walk(path?path+'/'+f.name:f.name));
                    });
                    
                    (data.files||[]).forEach(f=>{
                        node.children.push(Promise.resolve({
                            name: f.name, 
                            path: path?path+'/'+f.name:f.name, 
                            type:'file'
                        }));
                    });
                    
                    node.children = await Promise.all(node.children);
                    return node;
                }
                fullTree = await walk('');
            }
            
            // 渲染树，支持高亮和展开
            function renderTree(tree, filter = '') {
                $.treeView.innerHTML = '';
                
                function createNode(node) {
                    const lowerFilter = filter ? filter.toLowerCase() : '';
                    const lowerName = node.name.toLowerCase();
                    
                    // 只有节点名称包含整个搜索词时才高亮
                    const isMatch = lowerFilter && lowerName.includes(lowerFilter);
                    
                    let hasMatchChild = false;
                    let childrenEls = [];
                    
                    if (node.children && node.children.length) {
                        for (const child of node.children) {
                            const childResult = createNode(child);
                            if (childResult && childResult.el) childrenEls.push(childResult.el);
                            if (childResult && childResult.hasMatch) hasMatchChild = true;
                        }
                    }
                    
                    const expanded = filter && (isMatch || hasMatchChild);
                    let el;
                    
                    if (node.type === 'folder') {
                        el = document.createElement('div');
                        let folder = document.createElement('div');
                        folder.className = 'folder' + (expanded ? ' expanded' : '');
                        folder.innerHTML = '<span class="emoji-icon" aria-hidden="true">' + (expanded ? '📂' : '📁') + '</span>' + node.name;
                        folder.dataset.path = node.path;
                        folder.title = node.name;
                        if (isMatch) folder.classList.add('search-hit');
                        
                        let children = document.createElement('div');
                        children.className = 'children';
                        if (expanded) children.style.display = 'block';
                        else children.style.display = '';
                        
                        childrenEls.forEach(childEl => children.appendChild(childEl));
                        el.appendChild(folder);
                        if (children.children.length) el.appendChild(children);
                    } else {
                        el = document.createElement('div');
                        let file = document.createElement('div');
                        file.className = 'file';
                        let n = node.name.endsWith('.md') ? node.name.slice(0, -3) : node.name;
                        file.innerHTML = '<span class="emoji-icon" aria-hidden="true">📄</span>' + n;
                        file.dataset.path = node.path;
                        file.title = n;
                        if (isMatch) file.classList.add('search-hit');
                        
                        let children = document.createElement('div');
                        children.className = 'children';
                        children.style.display = 'none';
                        el.appendChild(file);
                        el.appendChild(children);
                    }
                    return { el, hasMatch: isMatch || hasMatchChild };
                }
                
                let root = tree;
                (root.children || []).forEach(child => {
                    const result = createNode(child);
                    if (result && result.el) $.treeView.appendChild(result.el);
                });
            }
            
            // 清除树和内容区高亮
            function clearTreeSearchHighlight() {
                document.querySelectorAll('.tree-view .search-hit').forEach(el => el.classList.remove('search-hit'));
            }
            
            function clearContentSearchHighlight() {
                document.querySelectorAll('.markdown-content .search-hit').forEach(el => {
                    const textNode = document.createTextNode(el.textContent);
                    el.parentNode.replaceChild(textNode, el);
                });
            }
            
            function scrollToHitElement(hit) {
                if (!hit) return;
                
                const container = document.querySelector('.markdown-container');
                if (!container) return;
                
                // 获取元素位置
                const elementRect = hit.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                
                // 计算元素在容器中的位置
                const elementTopRelativeToContainer = elementRect.top - containerRect.top;
                const elementBottomRelativeToContainer = elementRect.bottom - containerRect.top;
                
                // 检查元素是否在可视区域内
                const isInView = (
                    elementTopRelativeToContainer >= 0 &&
                    elementBottomRelativeToContainer <= containerRect.height
                );
                
                if (!isInView) {
                    // 计算需要滚动的距离
                    const scrollAmount = elementTopRelativeToContainer - containerRect.height / 4;
                    
                    // 平滑滚动到元素位置
                    container.scrollTo({
                        top: container.scrollTop + scrollAmount,
                        behavior: 'smooth'
                    });
                }
            }
            
            function searchContent(keyword) {
                clearContentSearchHighlight();
                
                if (!keyword) return false;

                const area = document.querySelector('.markdown-content');
                if (!area) return false;
                
                // 使用转义函数处理搜索关键词
                const escapedKeyword = escapeRegExp(keyword);
                const reg = new RegExp(escapedKeyword, 'gi');
                
                // 只在纯文本节点中高亮，跳过标签
                const walk = document.createTreeWalker(area, NodeFilter.SHOW_TEXT, null, false);
                const nodes = [];
                while (walk.nextNode()) {
                    nodes.push(walk.currentNode);
                }
                
                let foundMatch = false;
                
                nodes.forEach(node => {
                    if (!node.parentElement) return;
                    
                    // 重置正则表达式的lastIndex
                    reg.lastIndex = 0;
                    
                    if (!reg.test(node.nodeValue)) return;
                    
                    // 创建临时容器
                    const temp = document.createElement('span');
                    const matches = [];
                    
                    // 创建高亮元素并记录位置
                    let match;
                    reg.lastIndex = 0; // 再次重置
                    while ((match = reg.exec(node.nodeValue)) !== null) {
                        matches.push({
                            start: match.index,
                            end: match.index + match[0].length,
                            text: match[0]
                        });
                    }
                    
                    // 倒序处理匹配项，避免索引变化
                    for (let i = matches.length - 1; i >= 0; i--) {
                        const match = matches[i];
                        const hitSpan = document.createElement('span');
                        hitSpan.className = 'search-hit';
                        hitSpan.textContent = match.text;
                        
                        const before = document.createTextNode(node.nodeValue.substring(0, match.start));
                        const after = document.createTextNode(node.nodeValue.substring(match.end));
                        
                        const parent = node.parentNode;
                        parent.insertBefore(after, node.nextSibling);
                        parent.insertBefore(hitSpan, after);
                        parent.insertBefore(before, hitSpan);
                        
                        parent.removeChild(node);
                        
                        // 记录高亮元素
                        foundMatch = true;
                        node = after;
                    }
                });
                
                // 自动滚动到第一个高亮内容
                if (foundMatch) {
                    // 使用双重 requestAnimationFrame 确保在渲染后执行
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            const firstHit = area.querySelector('.search-hit');
                            if (firstHit) {
                                scrollToHitElement(firstHit);
                            }
                        });
                    });
                }
                
                return foundMatch;
            }
            
            // 防抖函数
            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }
            
            // 清空搜索框 - 修复：不再改变任何状态
            function clearSearch() {
                searchInput.value = '';
                const clearBtn = document.getElementById('search-clear');
                if (clearBtn) clearBtn.style.visibility = 'hidden';
                clearTreeSearchHighlight();
                clearContentSearchHighlight();
                const noResultBar = document.getElementById('search-no-result');
                if (noResultBar) noResultBar.style.display = 'none';
                cache.hasSearchResult = false;

                // 在窄屏下，清空搜索框时隐藏软键盘并移除焦点
                if (window.innerWidth <= 992) {
                    // 移动焦点到侧边栏标题按钮
                    const toggleBtn = document.getElementById('toggle-sidebar');
                    if (toggleBtn) {
                        toggleBtn.focus();
                    }
                    searchInput.blur();
                }
            }
            
            // 事件绑定
            $.navMenu.onclick = async e => {
                if(e.target.tagName === 'A'){
                    e.preventDefault();
                    clearTreeSearchHighlight();
                    clearContentSearchHighlight();
                    let p = e.target.dataset.path;
                    await loadFolder(p);
                    
                    // 在窄屏下点击菜单自动展开侧栏
                    expandSidebarIfNeeded();
                    
                    if(window.innerWidth <= 992) $.topNav.classList.remove('active');
                }
            };
            
            // 搜索类型切换与分流逻辑
            let searchMode = 'menu'; // menu 或 content
            const searchType = document.getElementById('search-type');
            const searchTypeLabel = document.getElementById('search-type-label');
            const searchTypeDropdown = document.getElementById('search-type-dropdown');
            
            if (searchType && searchTypeLabel && searchTypeDropdown) {
              searchType.onclick = function(e) {
                searchTypeDropdown.style.display = searchTypeDropdown.style.display === 'block' ? 'none' : 'block';
                e.stopPropagation();
              };
              
              document.addEventListener('click', function() {
                searchTypeDropdown.style.display = 'none';
              });
              
              searchTypeDropdown.querySelectorAll('div').forEach(opt => {
                opt.onclick = function(e) {
                  searchMode = this.getAttribute('data-type');
                  if (searchMode === 'menu') {
                    searchTypeLabel.textContent = '菜单';
                    searchInput.placeholder = '搜索菜单文档...';
                  } else {
                    searchTypeLabel.textContent = '内容';
                    searchInput.placeholder = '搜索当前内容...';
                  }
                  searchTypeDropdown.style.display = 'none';
                  e.stopPropagation();
                  
                  if (searchInput.value) {
                    clearTreeSearchHighlight();
                    clearContentSearchHighlight();
                    searchHandler();
                  } else {
                    clearTreeSearchHighlight();
                    clearContentSearchHighlight();
                  }
                  
                  // 窄屏下切换类型时自动隐藏虚拟键盘
                  if (window.innerWidth <= 992) {
                    searchInput.blur();
                  } else {
                    searchInput.focus();
                  }
                };
              });
            }
            
            // 搜索逻辑封装
            async function searchHandler() {
                const val = searchInput.value.trim();
                const sidebarTitle = document.getElementById('sidebar-title');
                const noResultBar = document.getElementById('search-no-result');
                const clearBtn = document.getElementById('search-clear');
                
                // 显示清除按钮
                if (clearBtn) clearBtn.style.visibility = val ? 'visible' : 'hidden';
                
                // 展开侧边栏（如果需要）
                expandSidebarIfNeeded();
                
                if (!val) {
                    clearTreeSearchHighlight();
                    clearContentSearchHighlight();
                    if (noResultBar) noResultBar.style.display = 'none';
                    cache.hasSearchResult = false;
                    return;
                }
                
                if (searchMode === 'menu') {
                    if (!fullTree) await buildFullTree();
                    
                    // 仅在匹配到内容时才刷新树形菜单
                    const hasMatches = hasMatchingItems(fullTree, val);
                    
                    if (hasMatches) {
                        renderTree(fullTree, val);
                        if (sidebarTitle) sidebarTitle.textContent = '青青小竹网';
                        
                        // 判断是否有高亮项
                        setTimeout(async ()=>{
                            const firstMenu = document.querySelector('.tree-view .search-hit');
                            if(firstMenu) {
                                firstMenu.scrollIntoView({behavior:'smooth', block:'center'});
                                if (noResultBar) noResultBar.style.display = 'none';
                                cache.hasSearchResult = true;
                                
                                // 如果第一个高亮是文件，自动打开
                                if(firstMenu.classList.contains('file')) {
                                    document.querySelectorAll('.file,.folder').forEach(el=>el.classList.remove('active'));
                                    firstMenu.classList.add('active','expanded');
                                    cache.currentFile = firstMenu;
                                    await showMd(firstMenu.dataset.path, firstMenu.parentElement.querySelector('.children'));
                                }
                            }
                        }, 0);
                    } else {
                        if (noResultBar) noResultBar.style.display = 'block';
                        cache.hasSearchResult = false;
                    }
                } else if (searchMode === 'content') {
                    const found = searchContent(val);
                    if (noResultBar) noResultBar.style.display = found ? 'none' : 'block';
                    cache.hasSearchResult = found;
                }
            }
            
            // 检查是否有匹配项
            function hasMatchingItems(tree, filter) {
                const lowerFilter = filter ? filter.toLowerCase() : '';
                
                function checkNode(node) {
                    if (node.name && node.name.toLowerCase().includes(lowerFilter)) {
                        return true;
                    }
                    
                    if (node.children && node.children.length) {
                        for (const child of node.children) {
                            if (checkNode(child)) {
                                return true;
                            }
                        }
                    }
                    
                    return false;
                }
                
                let root = tree;
                for (const child of root.children || []) {
                    if (checkNode(child)) {
                        return true;
                    }
                }
                
                return false;
            }
            
            // 搜索输入事件（添加防抖）
            const debouncedSearchHandler = debounce(searchHandler, 300);
            searchInput.addEventListener('input', function() {
                const clearBtn = document.getElementById('search-clear');
                if (clearBtn) clearBtn.style.visibility = this.value ? 'visible' : 'hidden';
                clearTreeSearchHighlight();
                clearContentSearchHighlight();
                document.getElementById('search-no-result').style.display = 'none';
                
                // 使用防抖处理搜索输入
                debouncedSearchHandler();
            });
            
            // 按下Enter键触发搜索
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    searchHandler();
                    if (window.innerWidth <= 992) {
                        searchInput.blur();
                    }
                } else if (e.key === 'Backspace' && this.value === '') {
                    // 清空搜索框
                    clearSearch();
                }
            });
            
            // 清除按钮点击事件
            const clearBtn = document.getElementById('search-clear');
            if (clearBtn) {
                clearBtn.addEventListener('click', function(e) {
                    clearSearch();
                });
                clearBtn.style.visibility = searchInput.value ? 'visible' : 'hidden';
            }
            
            $.treeView.onclick = async e => {
                let f = e.target.closest('.folder'), 
                    file = e.target.closest('.file');
                
                // 窄屏下菜单折叠时，点击顶级菜单自动展开侧栏
                if (f && window.innerWidth <= 992 && $.sidebar.classList.contains('collapsed')) {
                    expandSidebarIfNeeded();
                }
                
                // 处理点击事件前先检查是否需要清除提示
                const noResultBar = document.getElementById('search-no-result');
                if (noResultBar && noResultBar.style.display === 'block') {
                    // 在菜单搜索模式下点击任何项目都清除提示
                    if (searchMode === 'menu') {
                        clearSearch();
                    }
                }
                
                if(f){
                    let ch = f.parentElement.querySelector('.children');
                    ch.querySelectorAll('.folder.expanded').forEach(sf=>{
                        sf.classList.remove('expanded');
                    });
                    
                    ch.querySelectorAll('.children').forEach(sc=>sc.style.display='none');
                    f.classList.toggle('expanded');
                    
                    if(f.classList.contains('expanded')){
                        if(ch.children.length===0){
                            try {
                                let d=await loadVxJson(f.dataset.path);
                                ch.innerHTML='';
                                d.folders.forEach(sf=>ch.appendChild(folderElem(sf,f.dataset.path)));
                                d.files.forEach(fi=>ch.appendChild(fileElem(fi,f.dataset.path)));
                            } catch (error) {
                                showError(`加载子文件夹失败: ${error.message}`);
                            }
                        }
                        ch.style.display='block';
                    } else {
                        ch.style.display='none';
                    }
                } else if(file) {
                    let ch = file.parentElement.querySelector('.children');
                    if(cache.currentFile === file){
                        let o = ch.style.display === 'block';
                        ch.style.display = o ? 'none' : 'block';
                        file.classList.toggle('expanded',!o);
                        return;
                    }
                    
                    if(cache.currentFile){
                        let pch = cache.currentFile.parentElement.querySelector('.children');
                        if(pch) pch.style.display = 'none';
                        cache.currentFile.classList.remove('expanded','active');
                    }
                    
                    cache.currentFile = file;
                    document.querySelectorAll('.file,.folder').forEach(el=>el.classList.remove('active'));
                    file.classList.add('active','expanded');
                    const mdContainer = await showMd(file.dataset.path, ch);
                    
                    // 如果搜索框有内容且是内容搜索模式，在新文档中执行搜索
                    if (searchInput.value && searchMode === 'content') {
                        const found = searchContent(searchInput.value);
                        const noResultBar = document.getElementById('search-no-result');
                        if (noResultBar) {
                            noResultBar.style.display = found ? 'none' : 'block';
                        }
                        cache.hasSearchResult = found;
                    }
                }
            };
            
            $.sidebarHeader.onclick = (e) => {
                if (e.target.closest('#toggle-sidebar')) {
                    toggleSidebar();
                }
            };
            
            $.mobileMenuToggle.onclick = () => {
                $.topNav.classList.toggle('active');
            };
            
            // 页面初始化
            (async function(){
                cache.initialContentHTML = $.content.innerHTML;
                
                try {
                    let d = await loadVxJson('');
                    if(d.folders && d.folders.length){
                        $.navMenu.innerHTML = '';
                        d.folders.forEach(f => {
                            let li = document.createElement('li');
                            let a = document.createElement('a');
                            a.href = '#';
                            a.textContent = f.name;
                            a.dataset.path = f.name;
                            li.appendChild(a);
                            $.navMenu.appendChild(li);
                        });
                        cache.currentFolderPath = d.folders[0].name;
                        await loadFolder(cache.currentFolderPath);
                    }
                    setSidebarTitle(cache.currentFolderPath);
                } catch (error) {
                    showError(`初始化失败: ${error.message}`);
                }
            })();
        })();
    </script>
</body>
</html>