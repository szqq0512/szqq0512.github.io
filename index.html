<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>青青小竹网 | 旅游百科 | 各地景点</title>
    <script src="https://demo.likeyunba.com/md-marked/marked.min.js"></script>
    <style>
        :root {
            --primary: #6c5ce7;
            --light: #f7f7ff;
            --border: #e0e0e0;
            --text: #3d3d3d;
            --radius: 12px;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #f9f9f9;
            color: var(--text);
            overflow: hidden;
        }
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            width: 99%;
            max-width: 2200px;
            margin: 10px auto;
            gap: 15px;
        }
        .sidebar {
            width: 260px;
            background: #fff;
            border-radius: var(--radius);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }
        .sidebar-header {
            padding: 10px 12px;
            background: var(--primary);
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .sidebar-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .sidebar-header a {
            color: white;
            text-decoration: none;
        }
        .sidebar-header .toggle-btn { 
            display: none; 
        }
        .search-bar {
            display: flex;
            align-items: center;
            background: #fff;
            border-radius: var(--radius);
            padding: 2px 8px;
            gap: 6px;
            min-width: 0;
            height: 36px;
            margin: 0 10px 10px;
            position: relative; 
            border: 1px solid var(--border);
        }
        .search-bar input {
            border: none;
            outline: none;
            background: transparent;
            flex: 1;
            font-size: 1em;
            padding: 4px 0;
            min-width: 0;
            height: 28px;
            line-height: 28px;
            padding-right: 30px; 
        }
        .search-type {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0 10px;
            background: #f5f5fa;
            font-size: 1em;
            color: #6c5ce7;
            user-select: none;
            position: relative;
            height: 28px;
            min-width: 70px;
            line-height: 28px;
        }
        .search-type .dropdown-arrow { margin-left: 2px; font-size: 0.9em; }
        .search-type-dropdown {
            position: absolute;
            top: 110%;
            left: 0;
            background: #fff;
            min-width: 70px;
            z-index: 10;
            font-size: 1em;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        .search-type-dropdown div {
            padding: 2px 16px;
            cursor: pointer;
            color: #6c5ce7;
            background: #fff;
        }
        .search-type-dropdown div:hover { background: #e0ebff; }
        #search-clear {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.3em;
            cursor: pointer;
            color: #6c5ce7;
            user-select: none;
            z-index: 2;
            width: 1.5em;
            height: 1.5em;
            line-height: 1.5em;
            text-align: center;
        }
        #search-clear:hover {
            color: #fdcb6e;
            background: #f5f6fa;
            border-radius: 50%;
        }
        .tree-view {
            flex: 1;
            overflow-y: auto;
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            min-height: 100px;
        }
        .folder, .file, .heading-item {
            padding: 6px 10px 6px 1em;
            margin: 2px 5px;
            border-radius: var(--radius);
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            min-height: 28px;
            white-space: nowrap;
            overflow: hidden;
            background: var(--light);
        }
        .heading-item { padding-left: 2em; }
        .folder:hover, .file:hover, .heading-item:hover { 
            background: #e0ebff; 
        }
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f9f9f9;
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border);
        }
        .markdown-container {
            flex: 1;
            overflow-y: auto;
            padding: 2em;
            background: #fff;
            padding-bottom: max(2em, 12vh);
        }
        .markdown-content {
            line-height: 1.7;
            color: var(--text);
            font-size: 1.05rem;
            text-align: left;
        }
        .markdown-content > p { margin-top: 1em; }
        .markdown-content a { text-decoration: none; color: var(--primary); }
        .markdown-content a:hover { color: #00cec9; }

        /* 合并标题公共样式 */
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            padding-bottom: 4px !important;
            border-bottom: 1px solid #e0e0e0 !important;
        }
        .markdown-content h1 {
            color: #6c5ce7 !important;
            font-size: 2rem !important;
        }
        .markdown-content h2 {
            color: #00cec9 !important;
            font-size: 1.7rem !important;
            margin: 25px 0 15px !important;
        }
        .markdown-content h3 {
            color: #fd79a8 !important;
            font-size: 1.4rem !important;
            margin: 25px 0 15px !important;
        }

        .markdown-content ul { list-style: none; margin: 20px 0; }
        .markdown-content ul > li {
            position: relative;
            padding: 0.25em 0.5em;
            text-indent: -0.5em;
        }
        .markdown-content ul > li:nth-child(odd) { background-color: #f0f5ff; }
        .markdown-content blockquote {
            text-indent: 0em;
            font-size: 0.92em;
            font-style: italic;
            color: #008080;
            margin-left: 1em;
            border-left: 0.12em solid #008080;
            padding: 0 0.6em;
        }
        .markdown-content em { color: #346c91; font-style: normal; }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #b0b0b0;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

.markdown-content img,
.welcome-image,
.markdown-content table {
    max-width: min(99%, 1400px);
    height: auto;
    display: block;
    margin: 10px auto;
    border-collapse: collapse;
}

        .children { display: none; }
        .folder.expanded + .children { display: block; }
        .tree-view .children {
            margin-left: 1em;
        }
        .tree-view .children .folder,
        .tree-view .children .file {
            margin-left: inherit;
        }

        @media (max-width: 992px) {
            .container { width: 100%; flex-direction: column; padding: 0; margin: 0; gap: 0; }
            .sidebar { width: 100%; border-radius: 0; max-height: 50vh; border-bottom: 1px solid var(--border); }
            .sidebar.collapsed .search-bar,
            .sidebar.collapsed .search-no-result,
            .sidebar.collapsed .tree-view { 
                display: none; 
            } 
            .sidebar.collapsed { overflow: hidden; max-height: 60px; }
            .sidebar-header .toggle-btn { 
                display: block;
            }
            .content { border-radius: 0; }
            .markdown-container { padding: 0.8em; padding-bottom: 18vh !important; }
        }
        .toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px 10px;
        }
        .toggle-btn .emoji-icon { font-size: 1.6em; color: #fff; }
        .search-hit {
            background: #ffe066 !important;
            color: #d35400 !important;
            border-radius: 4px;
            padding: 0 2px;
        }
        .tree-view .search-hit {
            font-weight: bold;
        }
        .search-no-result {
            display: none;
            text-align: left;
            color: #b36b00;
            background: #fffbe6;
            margin: 0 10px 10px;
            padding: 7px 14px;
            font-size: 1em;
            border: 1px solid #ffe066;
            min-height: 1.5em;
            line-height: 1.5em;
            font-weight: 500;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }


        
        /* 双ID显示控制 */
        .node-view {
            display: flex;
            align-items: center;
            width: 100%;
        }
        .highlight-view {
            display: none;
        }
        .search-mode .normal-view {
            display: none;
        }
        .search-mode .highlight-view {
            display: flex !important;
        }

        .markdown-content th, 
        .markdown-content td {
            padding: 0.75em 1em;
            text-align: left;
            border: 1px solid #e0e0e0;
        }
        
        .markdown-content th {
            background-color: #f5f7fa;
            font-weight: 600;
            color: var(--primary);
        }
        
        .markdown-content tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* 加载指示器 */
        .search-loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header" id="sidebar-header">
                <h2 id="home-link">
                    <a href="#">
                        <span class="emoji-icon" aria-hidden="true">📖</span>
                        <span>青青小竹网</span>
                    </a>
                </h2>
                <button class="toggle-btn" id="toggle-sidebar" data-collapsed="false">
                    <span class="emoji-icon" aria-hidden="true">▽</span>
                    <span class="sr-only">折叠/展开</span>
                </button>
            </div>
            
            <div class="search-bar" id="search-bar">
                <div class="search-type" id="search-type" tabindex="0">
                    <span id="search-type-label">菜单</span>
                    <span class="dropdown-arrow">▼</span>
                    <div class="search-type-dropdown" id="search-type-dropdown" style="display:none;">
                        <div data-type="menu">菜单</div>
                        <div data-type="content">内容</div>
                    </div>
                </div>
                <input id="search-input" type="text" placeholder="搜索菜单文档..." />
                <span id="search-clear">╳</span>
            </div>
            <div id="search-no-result" class="search-no-result" style="display:none;">无此搜索项</div>
            
            <div class="tree-view" id="tree-view"></div>
        </aside>
        
        <main class="content" id="content">
            <div class="empty-state" id="welcome-content">
                <h2>欢迎使用青青小竹网</h2>
                <br>
                <p>一个简单的使用Markdown语法的个人笔记。</p>  
                <br>
                <p>从网上搜集整理的旅游相关资料，主要罗列了中国各地的概况、景点及特色村寨等，方便查找和出行规划。</p>
                <br>
                <p>请选择要查看的文件</p>
                <br>
                <img src="https://s1.imagehub.cc/images/2025/06/13/bf3432b185d01be77f7f9f78f3a79dd7.webp" 
                     alt="欢迎使用青青小竹网"
                     class="welcome-image" 
                     loading="lazy">
                <br>
                <p>免责声明</p>
                <p>本网站（仓库）的所有内容仅供个人参考之用，禁止用于商业用途。</p>
                <p>任何人或组织不得将本网站（仓库）的内容用于非法用途或侵犯他人合法权益，不得用于在其他平台进行传播。</p>
                <p>对于因使用本网站（仓库）内容而引起的任何法律责任，本网站（仓库）不承担任何责任。</p>
                <p>使用本网站（仓库）的内容即表示您同意本免责声明的所有条款和条件。</p>
            </div>
        </main>
    </div>
    
    <div class="search-loading" id="search-loading">搜索中...</div>

    <script>
        (() => {
            // 移动端搜索时自动展开侧边栏
            function expandSidebarIfNeeded() {
                if (window.innerWidth <= 992 && $.sidebar.classList.contains('collapsed')) {
                    $.sidebar.classList.remove('collapsed');
                    const icon = $.toggleSidebar.querySelector('.emoji-icon');
                    if (icon) icon.textContent = '▽';
                    $.toggleSidebar.setAttribute('data-collapsed', false);
                }
            }
            // 侧边栏折叠/展开切换函数
            function toggleSidebar() {
                const collapsed = $.sidebar.classList.toggle('collapsed');
                const icon = $.toggleSidebar.querySelector('.emoji-icon');
                if (icon) icon.textContent = collapsed ? '▷' : '▽';
                $.toggleSidebar.setAttribute('data-collapsed', collapsed);
            }
            // DOM 快捷选择器对象
            const $ = {
                sidebar: document.getElementById('sidebar'),
                homeLink: document.getElementById('home-link'),
                toggleSidebar: document.getElementById('toggle-sidebar'),
                searchType: document.getElementById('search-type'),
                searchTypeLabel: document.getElementById('search-type-label'),
                searchTypeDropdown: document.getElementById('search-type-dropdown'),
                searchInput: document.getElementById('search-input'),
                searchClear: document.getElementById('search-clear'),
                searchNoResult: document.getElementById('search-no-result'),
                treeView: document.getElementById('tree-view'),
                content: document.getElementById('content'),
                welcomeContent: document.getElementById('welcome-content'),
                searchLoading: document.getElementById('search-loading'),
            };

            // 异步加载vx.json
            async function loadVxJson(path) {
                try {
                    let r = await fetch(path ? `旅游/${path}/vx.json` : '旅游/vx.json');
                    // 验证是否为JSON
                    const contentType = r.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        return {folders:[],files:[]};
                    }
                    let d = await r.json();
                    cache.dirCache[path] = d; 
                    return d;
                } catch (error) {
                    return {folders:[],files:[]};
                }
            }
            // 状态
            const cache = {
                dirCache: {},
                mdContent: {},
                headings: {},
                currentFile: null,
                initialContentHTML: '',
                hasSearchResult: false,
                searchCanceled: false,
                pathMap: new Map(),
                isComposing: false,
                searchMatches: [],
                currentSearch: {
                    keyword: '',
                    type: 'menu',
                    lastKeyword: '',
                    lastType: ''
                },
                originalContent: null,
                firstHitElement: null
            };
            let fullTree = null;
            // 工具
            const utils = {
                cleanPath: (p) => {
                    if (!p) return '';
                    p = p.replace(/\\/g, '/').replace(/\/\//g, '/').trim();
                    if (p === '/') return '';
                    return p;
                },
                joinPath: (parentPath, childName) => {
                    if (!parentPath) return childName;
                    return `${parentPath.replace(/\/$/, '')}/${childName}`;
                },
                escapeRegExp: (string) => string.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&'),
                highlightText: (text, keyword) => {
                    if (!keyword) return text;
                    const reg = new RegExp(utils.escapeRegExp(keyword), 'gi');
                    return text.replace(reg, match => `<span class="search-hit">${match}</span>`);
                },
                safeSanitize: (html) => {
                    if (!html) return '';
                    const temp = document.createElement('div');
                    temp.innerHTML = html;
                    const elements = temp.querySelectorAll('*');
                    for (const el of elements) {
                        const tagName = el.tagName.toLowerCase();
                        if ([
                            'script', 'iframe', 'object', 'embed', 'link'
                        ].includes(tagName)) {
                            el.remove();
                            continue;
                        }
                        const attrs = el.attributes;
                        for (let i = attrs.length - 1; i >= 0; i--) {
                            const attr = attrs[i];
                            const name = attr.name.toLowerCase();
                            if (name.startsWith('on') || 
                                (name === 'href' && /^(javascript|data):/i.test(attr.value)) ||
                                (name === 'src' && /^(javascript|data):/i.test(attr.value))) {
                                el.removeAttribute(name);
                            }
                        }
                    }
                    return temp.innerHTML;
                },
                scrollToElement: (element) => {
                    if (!element) return;
                    const container = document.querySelector('.markdown-container');
                    if (!container) return;
                    setTimeout(() => {
                        const containerRect = container.getBoundingClientRect();
                        const elementRect = element.getBoundingClientRect();
                        const scrollTop = container.scrollTop;
                        const offset = elementRect.top - containerRect.top + scrollTop - 100;
                        container.scrollTo({
                            top: offset,
                            behavior: 'smooth'
                        });
                    }, 50);
                }
            };
            
            // 创建节点元素 - 统一使用📁图标
            function createNodeElem(isFolder, f, p) {
                const c = document.createElement('div');
                const e = document.createElement('div');
                e.className = isFolder ? 'folder' : 'file';
                
                // 统一使用📁作为文件夹图标
                const icon = isFolder ? '📁' : '📄';
                
                // 正确计算文件名
                let name;
                if (isFolder) {
                    name = f.name;
                } else {
                    name = f.name.endsWith('.md') ? f.name.slice(0, -3) : f.name;
                }
                
                // 修复模板字符串语法
                e.innerHTML = `
                    <div class="node-view normal-view">
                        <span class="emoji-icon" aria-hidden="true">${icon}</span>${name}
                    </div>
                    <div class="node-view highlight-view" style="display:none">
                        <span class="emoji-icon" aria-hidden="true">${icon}</span>${name}
                    </div>
                `;
                
                e.dataset.path = utils.joinPath(p, f.name);
                e.title = name;
                
                const ch = document.createElement('div');
                ch.className = 'children';
                ch.style.display = 'none';
                
                c.appendChild(e);
                c.appendChild(ch);
                return c;
            }
            
            async function fetchMd(filePath) {
                const full = utils.joinPath('旅游', filePath);
                if (cache.mdContent[full]) return cache.mdContent[full];
                try {
                    const r = await fetch(full);
                    if (!r.ok) return '';
                    const t = await r.text();
                    cache.mdContent[full] = t;
                    return t;
                } catch {
                    return '';
                }
            }
            
            function parseHeadings(md) {
                if (cache.headings[md]) return cache.headings[md];
                const h = [];
                window.marked.lexer(md).forEach(tok => {
                    if (tok.type === 'heading' && tok.depth <= 3) h.push({ level: tok.depth, text: tok.text });
                });
                cache.headings[md] = h;
                return h;
            }
 
            // 预处理Markdown文本 - 移除图片链接中的尺寸参数
            const preprocessMd = md => md.replace(/!\[(.*?)\]\((.*?)\s*=\s*\d+x\d*\s*\)/g, '![$1]($2)');
            
            // Markdown渲染函数
            async function showMd(filePath, headingsContainer) {
                await checkMarkedLoaded();
                let md = await fetchMd(filePath);
                
                // 预处理Markdown文本
                md = preprocessMd(md);
                
                let h = parseHeadings(md);
                let cont = document.createElement('div'); 
                cont.className = 'markdown-container';
                let area = document.createElement('div'); 
                area.className = 'markdown-content';
                let renderer = new window.marked.Renderer();
                let hid = 0;
                
                renderer.heading = function(token) {
                    const level = token.depth;
                    return `<h${level} id="heading-${level}-${hid++}">${token.text}</h${level}>`;
                };
                
                // 生成Markdown内容
                let htmlContent = window.marked.parse(md, {
                    renderer,
                    sanitize: true,
                    breaks: false,
                    gfm: true,
                    tables: true
                });
                
                // 应用安全过滤
                area.innerHTML = utils.safeSanitize(htmlContent);
                
                // 保存原始内容
                cache.originalContent = area.cloneNode(true);
                cache.firstHitElement = null;
                
                cont.appendChild(area);
                genHeadingsTree(h, headingsContainer);
                $.content.innerHTML = ''; 
                $.content.appendChild(cont);
                
                // 如果当前有内容搜索，在新文档中执行搜索
                if (cache.currentSearch.type === 'content' && cache.currentSearch.keyword) {
                    const found = await searchContent(cache.currentSearch.keyword);
                    
                    // 如果没有匹配项，显示提示
                    if (!found) {
                        $.searchNoResult.style.display = 'block';
                        $.searchNoResult.textContent = '无此搜索项';
                    } else {
                        $.searchNoResult.style.display = 'none';
                    }
                }
                
                return cont;
            }
            
function genHeadingsTree(h, c) {
    if (!c) return;
    c.innerHTML = '';
    c.style.display = 'block';
    h.forEach(he => {
        const hi = document.createElement('div');
        hi.className = `heading-item h${he.level}`;
        const icon = he.level === 1 ? '› ' : he.level === 2 ? ' » ' : he.level === 3 ? '  »› ' : '';
        hi.innerHTML = `<span class="emoji-icon" aria-hidden="true">${icon}</span><span>${he.text}</span>`;
        hi.onclick = e => {
            e.stopPropagation();
            scrollToHeading(he.text, he.level);
        };
        c.appendChild(hi);
    });
    function scrollToHeading(text, level) {
        let hs = document.querySelectorAll(`h${level}`);
        let t = Array.from(hs).find(h => h.textContent === text);
        if (t) {
            let container = document.querySelector('.markdown-container');
            let cr = container.getBoundingClientRect();
            let tr = t.getBoundingClientRect();
            let st = container.scrollTop;
            let off = tr.top - cr.top + st - 12;
            container.scrollTo({ top: off, behavior: 'smooth' });
        }
    }
}
            
            // 确保marked.js加载完成
            async function checkMarkedLoaded() {
                if (window.marked) return;
                
                return new Promise((resolve) => {
                    const maxWaitTime = 3000;
                    const startTime = Date.now();
                    
                    const interval = setInterval(() => {
                        if (window.marked) {
                            clearInterval(interval);
                            resolve();
                        } else if (Date.now() - startTime > maxWaitTime) {
                            clearInterval(interval);
                            resolve();
                        }
                    }, 100);
                });
            }
            
            // 构建全量树
            async function buildFullTree() {
                async function walk(path) {
                    const data = await loadVxJson(path);
                    let node = {
                        name: path.split('/').pop()||'根目录', 
                        path, 
                        type:'folder', 
                        children:[],
                        expanded: false
                    };
                    
                    // 添加到路径映射
                    cache.pathMap.set(path, node);
                    
                    (data.folders||[]).forEach(f=>{
                        const childPath = path ? `${path}/${f.name}` : f.name;
                        node.children.push(walk(childPath));
                    });
                    
                    (data.files||[]).forEach(f=>{
                        const filePath = path ? `${path}/${f.name}` : f.name;
                        const fileNode = {
                            name: f.name, 
                            path: filePath, 
                        };
                        node.children.push(Promise.resolve(fileNode));
                        cache.pathMap.set(filePath, fileNode);
                    });
                    
                    node.children = await Promise.all(node.children);
                    return node;
                }
                fullTree = await walk('');
            }
            
            // 渲染树
            function renderTree(tree) {
                $.treeView.innerHTML = '';
                
                function createNode(node) {
                    let el;
                    
                    if (node.type === 'folder') {
                        el = document.createElement('div');
                        let folder = document.createElement('div');
                        folder.className = 'folder';
                        
                        // 统一使用📁图标
                        const folderIcon = '📁';
                        folder.innerHTML = `
                            <div class="node-view normal-view">
                                <span class="emoji-icon" aria-hidden="true">${folderIcon}</span>${node.name}
                            </div>
                            <div class="node-view highlight-view" style="display:none">
                                <span class="emoji-icon" aria-hidden="true">${folderIcon}</span>${node.name}
                            </div>
                        `;
                        
                        folder.dataset.path = node.path;
                        folder.title = node.name;
                        
                        let children = document.createElement('div');
                        children.className = 'children';
                        children.style.display = node.expanded ? 'block' : 'none';
                        
                        if (node.children && node.children.length) {
                            node.children.forEach(child => {
                                const childResult = createNode(child);
                                if (childResult) children.appendChild(childResult);
                            });
                        }
                        
                        el.appendChild(folder);
                        el.appendChild(children);
                    } else {
                        el = document.createElement('div');
                        let file = document.createElement('div');
                        file.className = 'file';
                        
                        let n = node.name.endsWith('.md') ? node.name.slice(0, -3) : node.name;
                        file.innerHTML = `
                            <div class="node-view normal-view">
                                <span class="emoji-icon" aria-hidden="true">📄</span>${n}
                            </div>
                            <div class="node-view highlight-view" style="display:none">
                                <span class="emoji-icon" aria-hidden="true">📄</span>${n}
                            </div>
                        `;
                        
                        file.dataset.path = node.path;
                        file.title = n;
                        
                        let children = document.createElement('div');
                        children.className = 'children';
                        children.style.display = 'none';
                        el.appendChild(file);
                        el.appendChild(children);
                    }
                    return el;
                }
                
                let root = tree;
                (root.children || []).forEach(child => {
                    const result = createNode(child);
                    if (result) $.treeView.appendChild(result);
                });
            }
            
            // 搜索高亮功能
            const applySearchHighlight = keyword => {
                if (!keyword) return;
                const lowerKeyword = keyword.toLowerCase();
                cache.searchMatches = [];
                collapseAllFolders();
                $.treeView.querySelectorAll('.folder, .file').forEach(node => {
                    const name = node.dataset.path.split('/').pop().replace('.md', '');
                    if (name.toLowerCase().includes(lowerKeyword)) {
                        // 高亮
                        const highlightView = node.querySelector('.highlight-view');
                        if (highlightView) {
                            const icon = node.querySelector('.emoji-icon').textContent;
                            highlightView.innerHTML = `<span class="emoji-icon" aria-hidden="true">${icon}</span>${utils.highlightText(name, keyword)}`;
                        }
                        node.classList.add('search-hit');
                        cache.searchMatches.push({ element: node, isFile: node.classList.contains('file') });
                        expandParentContainers(node);
                    } else {
                        node.classList.remove('search-hit');
                    }
                });
                const foundMatch = cache.searchMatches.length > 0;
                $.searchNoResult.style.display = foundMatch ? 'none' : 'block';
                cache.hasSearchResult = foundMatch;
                if (foundMatch) setTimeout(() => cache.searchMatches[0].element.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
                if (cache.searchMatches.length === 1 && cache.searchMatches[0].isFile) setTimeout(() => cache.searchMatches[0].element.click(), 200);
            };
            
            // 展开匹配节点的父级容器
            function expandParentContainers(node) {
                let parent = node.closest('.children');
                while (parent) {
                    const folder = parent.previousElementSibling;
                    if (folder && folder.classList.contains('folder')) {
                        folder.classList.add('expanded');
                        parent.style.display = 'block';
                    }
                    parent = parent.parentElement.closest('.children');
                }
            }
            
            // 内容搜索高亮函数（优化版本）
            async function searchContent(keyword) {
                // 显示加载指示器
                $.searchLoading.style.display = 'block';
                
                // 重置搜索状态
                cache.searchCanceled = false;
                cache.firstHitElement = null;
                
                // 清除之前的高亮
                clearHighlights();
                
                if (!keyword) {
                    $.searchLoading.style.display = 'none';
                    return false;
                }

                const area = document.querySelector('.markdown-content');
                if (!area) {
                    $.searchLoading.style.display = 'none';
                    return false;
                }
                
                // 安全过滤关键词
                keyword = keyword.replace(/[<>"'`]/g, '');
                
                // 恢复原始内容
                if (cache.originalContent) {
                    area.innerHTML = cache.originalContent.innerHTML;
                }
                
                const escapedKeyword = utils.escapeRegExp(keyword);
                const reg = new RegExp(escapedKeyword, 'gi');
                
                // 获取所有文本节点
                const textNodes = [];
                const walker = document.createTreeWalker(area, NodeFilter.SHOW_TEXT);
                while (walker.nextNode()) {
                    textNodes.push(walker.currentNode);
                }
                
                let foundMatch = false;
                let firstHit = null;
                
                // 分批处理文本节点
                const batchSize = 50;
                let batchIndex = 0;
                
                // 分批处理函数
                const processBatch = () => {
                    if (cache.searchCanceled) {
                        $.searchLoading.style.display = 'none';
                        return;
                    }
                    
                    const batch = textNodes.slice(batchIndex, batchIndex + batchSize);
                    batchIndex += batchSize;
                    
                    for (const node of batch) {
                        if (cache.searchCanceled) break;
                        
                        const text = node.nodeValue;
                        let match;
                        let lastIndex = 0;
                        let newContent = '';
                        let hasMatchInNode = false;
                        
                        while ((match = reg.exec(text)) !== null) {
                            foundMatch = true;
                            hasMatchInNode = true;
                            
                            // 记录第一个匹配项
                            if (!firstHit) {
                                firstHit = match;
                            }
                            
                            newContent += text.substring(lastIndex, match.index);
                            newContent += `<span class="search-hit">${match[0]}</span>`;
                            
                            lastIndex = match.index + match[0].length;
                        }
                        
                        newContent += text.substring(lastIndex);
                        
                        if (hasMatchInNode) {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = newContent;
                            
                            const parent = node.parentNode;
                            while (tempDiv.firstChild) {
                                parent.insertBefore(tempDiv.firstChild, node);
                            }
                            parent.removeChild(node);
                        }
                    }
                    
                    // 如果还有更多节点，处理下一批
                    if (batchIndex < textNodes.length) {
                        setTimeout(processBatch, 10); // 添加延迟避免阻塞UI
                    } else {
                        // 处理完成
                        $.searchLoading.style.display = 'none';
                        
                        // 滚动到第一个匹配项
                        if (firstHit) {
                            setTimeout(() => {
                                const firstHitElement = area.querySelector('.search-hit');
                                if (firstHitElement) {
                                    utils.scrollToElement(firstHitElement);
                                }
                            }, 100);
                        }
                    }
                };
                
                // 开始处理第一批
                processBatch();
                
                return new Promise(resolve => {
                    // 设置超时以确保最终解析
                    setTimeout(() => {
                        resolve(foundMatch);
                    }, 1000);
                });
            }
            
            // 防抖函数
            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }
            
            // 清空搜索框
            function clearSearch() {
                cache.searchCanceled = true;
                
                $.searchInput.value = '';
                $.searchClear.style.visibility = 'hidden';
                clearHighlights();
                cache.hasSearchResult = false;
                cache.currentSearch.keyword = '';
                cache.searchMatches = [];
                $.searchNoResult.style.display = 'none';
                
                // 重置最后搜索记录
                cache.currentSearch.lastKeyword = '';
                cache.currentSearch.lastType = '';
                
                if (window.innerWidth <= 992) {
                    $.searchInput.blur();
                }
            }
            
            // 折叠所有打开的文件夹
            function collapseAllFolders() {
                document.querySelectorAll('.folder.expanded').forEach(folder => {
                    folder.classList.remove('expanded');
                    const childrenContainer = folder.parentElement.querySelector('.children');
                    if (childrenContainer) {
                        childrenContainer.style.display = 'none';
                    }
                });
                
                document.querySelectorAll('.file,.folder').forEach(el => el.classList.remove('active'));
            }
            
            function clearHighlights() {
                // 清除菜单高亮
                const menuItems = $.treeView.querySelectorAll('.folder, .file');
                menuItems.forEach(item => {
                    item.classList.remove('search-hit');
                    
                    // 重置高亮视图的HTML
                    const normalView = item.querySelector('.normal-view');
                    const highlightView = item.querySelector('.highlight-view');
                    if (normalView && highlightView) {
                        highlightView.innerHTML = normalView.innerHTML;
                    }
                });
                
                // 清除内容高亮 - 恢复原始内容
                const area = document.querySelector('.markdown-content');
                if (area && cache.originalContent) {
                    area.innerHTML = cache.originalContent.innerHTML;
                }
                
                // 移除搜索模式
                $.treeView.classList.remove('search-mode');
                $.searchNoResult.style.display = 'none';
                cache.searchMatches = [];
            }
            
            // 搜索策略映射
            const searchStrategies = {
                menu: async (val) => {
                    if (!fullTree) await buildFullTree();
                    
                    // 应用双ID高亮方案
                    $.treeView.classList.add('search-mode');
                    
                    applySearchHighlight(val);
                    
                    // 保存当前搜索状态
                    cache.currentSearch.keyword = val;
                    cache.currentSearch.type = 'menu';
                    cache.currentSearch.lastKeyword = val;
                    cache.currentSearch.lastType = 'menu';
                },
                content: async (val) => {
                    // 重置搜索取消标志
                    cache.searchCanceled = false;
                    
                    const found = await searchContent(val);
                    
                    // 更新状态
                    cache.hasSearchResult = found;
                    
                    // 显示/隐藏无结果提示
                    $.searchNoResult.style.display = found ? 'none' : 'block';
                    $.searchNoResult.textContent = found ? '' : '无此搜索项';
                    
                    // 保存当前搜索状态
                    cache.currentSearch.keyword = val;
                    cache.currentSearch.type = 'content';
                    cache.currentSearch.lastKeyword = val;
                    cache.currentSearch.lastType = 'content';
                }
            };
            
            // 搜索逻辑封装
            async function searchHandler() {
                const val = $.searchInput.value.trim();
                
                // 显示清除按钮
                $.searchClear.style.visibility = val ? 'visible' : 'hidden';
                
                // 展开侧边栏（如果需要）
                expandSidebarIfNeeded();
                
                if (!val) {
                    clearHighlights();
                    cache.hasSearchResult = false;
                    cache.currentSearch.keyword = '';
                    $.searchNoResult.style.display = 'none';
                    
                    // 重置最后搜索记录
                    cache.currentSearch.lastKeyword = '';
                    cache.currentSearch.lastType = '';
                    return;
                }
                
                // 避免重复搜索相同内容（但允许空到非空的搜索）
                if (cache.currentSearch.lastKeyword === val && 
                    cache.currentSearch.lastType === searchMode && 
                    cache.hasSearchResult) {
                    return;
                }
                
                // 使用策略模式处理不同搜索类型
                await searchStrategies[searchMode]?.(val);
            }
            
            // 中文输入法处理
            $.searchInput.addEventListener('compositionstart', () => {
                cache.isComposing = true;
            });
            
            $.searchInput.addEventListener('compositionend', () => {
                cache.isComposing = false;
                // 组合输入结束后执行一次搜索
                searchHandler();
            });
            
            // 搜索输入事件（添加防抖）
            const debouncedSearchHandler = debounce(searchHandler, 300);
            $.searchInput.addEventListener('input', function() {
                // 如果是中文输入法组合状态，不执行搜索
                if (cache.isComposing) return;
                
                // 当输入完全清空时完全重置状态
                if (this.value === '') {
                    clearSearch();
                    return;
                }
                
                clearHighlights();
                debouncedSearchHandler();
            });
            
            // 按下Enter键触发搜索
            $.searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    // 如果是中文输入法组合状态，不执行搜索
                    if (cache.isComposing) return;
                    
                    searchHandler();
                    if (window.innerWidth <= 992) {
                        this.blur();
                    }
                }
            });
            
            // 清除按钮点击事件
            $.searchClear.addEventListener('click', function() {
                clearSearch();
            });
            
            // 折叠所有打开的文件夹
            function closeUnrelatedFolders(currentPath) {
                const pathSegments = currentPath.split('/');
                const ancestorPaths = [];
                let tempPath = '';
                for (let i = 0; i < pathSegments.length; i++) {
                    tempPath = tempPath ? tempPath + '/' + pathSegments[i] : pathSegments[i];
                    ancestorPaths.push(tempPath);
                }
                
                document.querySelectorAll('.folder.expanded').forEach(folder => {
                    const folderPath = folder.dataset.path;
                    if (!ancestorPaths.includes(folderPath)) {
                        folder.classList.remove('expanded');
                        const childrenContainer = folder.parentElement.querySelector('.children');
                        if (childrenContainer) {
                            childrenContainer.style.display = 'none';
                        }
                    }
                });
            }
            
$.treeView.onclick = async e => {
    let f = e.target.closest('.folder'), file = e.target.closest('.file');
    if (f && window.innerWidth <= 992 && $.sidebar.classList.contains('collapsed')) {
        expandSidebarIfNeeded();
    }
    if ($.searchNoResult.style.display === 'block') {
        clearSearch();
    }
    if (f) {
        const currentPath = f.dataset.path;
        closeUnrelatedFolders(currentPath);
        let ch = f.parentElement.querySelector('.children');
        const isExpanding = !f.classList.contains('expanded');
        f.classList.toggle('expanded', isExpanding);
        if (isExpanding) {
            if (ch.children.length === 0) {
                // 懒加载子目录
                const data = await loadVxJson(currentPath);
                (data.folders || []).forEach(subf => {
                    ch.appendChild(createNodeElem(true, subf, currentPath));
                });
                (data.files || []).forEach(subf => {
                    ch.appendChild(createNodeElem(false, subf, currentPath));
                });
            }
            ch.style.display = 'block';
        } else {
            ch.style.display = 'none';
        }
    } else if (file) {
        if (cache.currentFile === file) {
            return;
        }
        document.querySelectorAll('.file.active').forEach(el => el.classList.remove('active'));
        file.classList.add('active');
        cache.currentFile = file;
        await showMd(file.dataset.path); // 不传第二个参数
    }
};
            
            $.toggleSidebar.onclick = toggleSidebar;
            
            // 搜索类型切换与分流逻辑
            let searchMode = 'menu';
            $.searchType.addEventListener('click', e => {
                $.searchTypeDropdown.style.display = $.searchTypeDropdown.style.display === 'block' ? 'none' : 'block';
                e.stopPropagation();
            });
            document.addEventListener('click', () => {
                $.searchTypeDropdown.style.display = 'none';
            });
            $.searchTypeDropdown.querySelectorAll('div').forEach(opt => {
                opt.addEventListener('click', e => {
                    searchMode = opt.getAttribute('data-type');
                    if (searchMode === 'menu') {
                        $.searchTypeLabel.textContent = '菜单';
                        $.searchInput.placeholder = '搜索菜单文档...';
                        clearHighlights();
                    } else {
                        $.searchTypeLabel.textContent = '内容';
                        $.searchInput.placeholder = '搜索当前内容...';
                        clearHighlights();
                    }
                    $.searchTypeDropdown.style.display = 'none';
                    e.stopPropagation();
                    cache.currentSearch.type = searchMode;
                    if ($.searchInput.value) searchHandler();
                    if (window.innerWidth <= 992) {
                        $.searchInput.blur();
                    } else {
                        $.searchInput.focus();
                    }
                });
            });
            
            // 返回首页功能
            function returnToHome() {
                // 清除搜索
                clearSearch();
                
                // 折叠所有菜单节点
                collapseAllFolders();
                
                // 清除当前文件选择
                if (cache.currentFile) {
                    cache.currentFile.classList.remove('active', 'expanded');
                    const pch = cache.currentFile.nextElementSibling;
                    if (pch && pch.classList.contains('children')) {
                        pch.style.display = 'none';
                    }
                    cache.currentFile = null;
                }
                
                // 显示欢迎内容
                $.content.innerHTML = '';
                const welcomeClone = $.welcomeContent.cloneNode(true);
                $.content.appendChild(welcomeClone);
                
                // 滚动到顶部
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            // 添加返回首页事件监听
            $.homeLink.addEventListener('click', e => {
                e.preventDefault();
                returnToHome();
            });
            
            // 初始化函数
            async function initApp() {
                cache.initialContentHTML = $.content.innerHTML;
                
                try {
                    await buildFullTree();
                    if (fullTree) {
                        renderTree(fullTree);
                    }
                } catch (error) {
                    // 静默失败
                }
            }
            
            // 设置事件监听器
            // 事件监听和初始化
            window.addEventListener('resize', () => {
                if (window.innerWidth > 992) {
                    $.sidebar.classList.remove('collapsed');
                    const icon = $.toggleSidebar.querySelector('.emoji-icon');
                    if (icon) icon.textContent = '▽';
                    $.toggleSidebar.setAttribute('data-collapsed', false);
                }
            });
            initApp();
        })();
    </script>
</body>
</html>